<project name="upload" default="upload" basedir=".">
    <description>
        Ant build file used to upload binaries to openjpa.apache.org/builds/latest. 
    </description>
    <target name="upload">

        <property name="build.dir" value="/www/openjpa.apache.org/builds"/>
        <property name="host" value="people.apache.org"/>

        <mkdir dir="target/site/tempDocs" />
        <unzip dest="target/site/tempDocs">
            <fileset dir="target/site/downloads">
                <include name="*binary*.zip" />
            </fileset>
            <patternset>
                <include name="**/javadoc/**" />
                <include name="**/manual/**" />
            </patternset>
        </unzip>
        <zip destfile="target/site/tempDocs/docs.zip">
            <fileset dir="target/site/tempDocs">
                <include name="**/javadoc/**"/>
                <include name="**/manual/**"/>
                <exclude name="docs/**"/>
            </fileset>
        </zip>
        <checksum> 
            <fileset dir="target/site/downloads/">
                <include name="*.zip" />
            </fileset>
        </checksum>
        
        <scp todir="${nightly.user.name}:${nightly.password}@${host}:${build.dir}" trust="true">
            <fileset dir="target/site/tempDocs"> 
                <include name="docs.zip"/>
            </fileset>
        </scp>
        <sshexec host="${host}" username="${nightly.user.name}" password="${nightly.password}" command="unzip -qq -d ${build.dir}/ ${build.dir}/docs.zip" trust="true" />
        <sshexec host="${host}" username="${nightly.user.name}" password="${nightly.password}" command="rm ${build.dir}/docs.zip" trust="true" />
        <sshexec host="${host}" username="${nightly.user.name}" password="${nightly.password}" command="mkdir ${build.dir}/apache-openjpa-${pom.version}/downloads " trust="true" />
        
        <scp todir="${nightly.user.name}:${nightly.password}@${host}:${build.dir}/apache-openjpa-${pom.version}/downloads" trust="true">
            <fileset dir="target/site/downloads" />
        </scp>
        
        <sshexec host="${host}" username="${nightly.user.name}" password="${nightly.password}" command="chmod -R g+w ${build.dir}/apache-openjpa-${pom.version}" trust="true" />
        
        <delete>
            <fileset dir="target/site/tempDocs" />
        </delete>
    </target>
</project>

